<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>星垣大六壬</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css?v=2.2">
    <style>
        /* 可以添加任何额外的内联样式 */
    </style>
</head>
<body>
    <div class="container">
        <h1>星垣大六壬</h1>
                
        <!-- 移除顶部的占时选择框，并修改控制面板 -->
        <div class="control-panel">
            <div class="control-group">
                <button id="calculate-btn">排盘 (使用当前时间)</button>
                <button id="auto-update-btn">自动更新</button>

                <button onclick="window.calculator && calculator.setCurrentDateTime()">设置当前时间</button>
                <button onclick="window.calculator && calculator.toggleAutoUpdate()">切换自动更新</button>
                <button onclick="window.calculator && calculator.openQianfaModal()">显示钤法</button>
                <button onclick="window.calculator && calculator.openQianfaModal('nayin')">查看纳音</button>
                <button onclick="window.triggerZeidunCalculation && window.triggerZeidunCalculation()">计算贼遁</button>
                <button onclick="window.applyZeidunFix && window.applyZeidunFix()">修复贼遁位置</button>
                <button onclick="window.applyFanyinFix && window.applyFanyinFix()">修复反吟</button>
            </div>
        </div>

        <!-- 排盘方式 -->
        <div class="row mb-3 mt-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">排盘方式</div>
                    <div class="card-body">
                        <div class="row mb-2">
                            <div class="col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="time-selection" id="current-time" checked>
                                    <label class="form-check-label" for="current-time">当前时间</label>
                                </div>
                                <div class="mt-2">

                                    <select id="time-branch" class="form-select">
                                        <option value="子">子时 (23:00-1:00)</option>
                                        <option value="丑">丑时 (1:00-3:00)</option>
                                        <option value="寅">寅时 (3:00-5:00)</option>
                                        <option value="卯">卯时 (5:00-7:00)</option>
                                        <option value="辰">辰时 (7:00-9:00)</option>
                                        <option value="巳">巳时 (9:00-11:00)</option>
                                        <option value="午">午时 (11:00-13:00)</option>
                                        <option value="未">未时 (13:00-15:00)</option>
                                        <option value="申">申时 (15:00-17:00)</option>
                                        <option value="酉">酉时 (17:00-19:00)</option>
                                        <option value="戌">戌时 (19:00-21:00)</option>
                                        <option value="亥">亥时 (21:00-23:00)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="time-selection" id="random-number">
                                    <label class="form-check-label" for="random-number">随机数起盘</label>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="time-selection" id="custom-time">
                                    <label class="form-check-label" for="custom-time">自定义时间</label>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="time-selection" id="custom-sizhu">
                                    <label class="form-check-label" for="custom-sizhu">自定义四柱</label>
                                </div>
                            </div>
                        </div>

                <!-- 月将选择 - 只在非自定义四柱模式下显示 -->
                <div class="row mb-3" id="month-general-container">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <input type="checkbox" id="month-general-manual" class="me-2">
                            <label for="month-general-manual" class="me-2">手动选择月将</label>
                        </div>
                        <select id="month-general" class="form-select">
                            <option value="亥">正月雨水后 - 亥(登明)</option>
                            <option value="戌">二月春分后 - 戌(河魁)</option>
                            <option value="酉">三月谷雨后 - 酉(从魁)</option>
                            <option value="申">四月小满后 - 申(传送)</option>
                            <option value="未">五月夏至后 - 未(小吉)</option>
                            <option value="午">六月大暑后 - 午(胜光)</option>
                            <option value="巳">七月处暑后 - 巳(太乙)</option>
                            <option value="辰">八月白露后 - 辰(天罡)</option>
                            <option value="卯">九月寒露后 - 卯(太冲)</option>
                            <option value="寅">十月立冬后 - 寅(功曹)</option>
                            <option value="丑">十一月大雪后 - 丑(大吉)</option>
                            <option value="子">十二月小寒后 - 子(神后)</option>
                        </select>
                    </div>
                </div>

                        <!-- 自定义四柱输入 -->
                        <div id="custom-sizhu-input" class="mt-3 d-none">
                            <div class="row mb-3">
                                <div class="col-md-3 mb-2">
                                    <label class="form-label">年干</label>
                                    <select class="form-select" id="custom-year-gan"></select>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <label class="form-label">月干</label>
                                    <select class="form-select" id="custom-month-gan"></select>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <label class="form-label">日干</label>
                                    <select class="form-select" id="custom-day-gan"></select>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <label class="form-label">时干</label>
                                    <select class="form-select" id="custom-hour-gan"></select>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-3 mb-2">
                                    <label class="form-label">年支</label>
                                    <select class="form-select" id="custom-year-zhi"></select>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <label class="form-label">月支</label>
                                    <select class="form-select" id="custom-month-zhi"></select>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <label class="form-label">日支</label>
                                    <select class="form-select" id="custom-day-zhi"></select>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <label class="form-label">时支</label>
                                    <select class="form-select" id="custom-hour-zhi"></select>
                                </div>
                            </div>
                        </div>

                        <!-- 本命和行年设置 -->
                        <div class="row mb-3">
                            <div class="col-md-6 mb-3">
                                <label for="birth-year" class="form-label">出生年</label>
                                <select class="form-select" id="birth-year">
                                    <option value="">请选择</option>
                                    <!-- 从1930年到2023年 -->
                                    <option value="1930">1930</option>
                                    <option value="1931">1931</option>
                                    <option value="1932">1932</option>
                                    <option value="1933">1933</option>
                                    <option value="1934">1934</option>
                                    <option value="1935">1935</option>
                                    <option value="1936">1936</option>
                                    <option value="1937">1937</option>
                                    <option value="1938">1938</option>
                                    <option value="1939">1939</option>
                                    <option value="1940">1940</option>
                                    <option value="1941">1941</option>
                                    <option value="1942">1942</option>
                                    <option value="1943">1943</option>
                                    <option value="1944">1944</option>
                                    <option value="1945">1945</option>
                                    <option value="1946">1946</option>
                                    <option value="1947">1947</option>
                                    <option value="1948">1948</option>
                                    <option value="1949">1949</option>
                                    <option value="1950">1950</option>
                                    <option value="1951">1951</option>
                                    <option value="1952">1952</option>
                                    <option value="1953">1953</option>
                                    <option value="1954">1954</option>
                                    <option value="1955">1955</option>
                                    <option value="1956">1956</option>
                                    <option value="1957">1957</option>
                                    <option value="1958">1958</option>
                                    <option value="1959">1959</option>
                                    <option value="1960">1960</option>
                                    <option value="1961">1961</option>
                                    <option value="1962">1962</option>
                                    <option value="1963">1963</option>
                                    <option value="1964">1964</option>
                                    <option value="1965">1965</option>
                                    <option value="1966">1966</option>
                                    <option value="1967">1967</option>
                                    <option value="1968">1968</option>
                                    <option value="1969">1969</option>
                                    <option value="1970">1970</option>
                                    <option value="1971">1971</option>
                                    <option value="1972">1972</option>
                                    <option value="1973">1973</option>
                                    <option value="1974">1974</option>
                                    <option value="1975">1975</option>
                                    <option value="1976">1976</option>
                                    <option value="1977">1977</option>
                                    <option value="1978">1978</option>
                                    <option value="1979">1979</option>
                                    <option value="1980">1980</option>
                                    <option value="1981">1981</option>
                                    <option value="1982">1982</option>
                                    <option value="1983">1983</option>
                                    <option value="1984">1984</option>
                                    <option value="1985">1985</option>
                                    <option value="1986">1986</option>
                                    <option value="1987">1987</option>
                                    <option value="1988">1988</option>
                                    <option value="1989">1989</option>
                                    <option value="1990">1990</option>
                                    <option value="1991">1991</option>
                                    <option value="1992">1992</option>
                                    <option value="1993">1993</option>
                                    <option value="1994">1994</option>
                                    <option value="1995">1995</option>
                                    <option value="1996">1996</option>
                                    <option value="1997">1997</option>
                                    <option value="1998">1998</option>
                                    <option value="1999">1999</option>
                                    <option value="2000">2000</option>
                                    <option value="2001">2001</option>
                                    <option value="2002">2002</option>
                                    <option value="2003">2003</option>
                                    <option value="2004">2004</option>
                                    <option value="2005">2005</option>
                                    <option value="2006">2006</option>
                                    <option value="2007">2007</option>
                                    <option value="2008">2008</option>
                                    <option value="2009">2009</option>
                                    <option value="2010">2010</option>
                                    <option value="2011">2011</option>
                                    <option value="2012">2012</option>
                                    <option value="2013">2013</option>
                                    <option value="2014">2014</option>
                                    <option value="2015">2015</option>
                                    <option value="2016">2016</option>
                                    <option value="2017">2017</option>
                                    <option value="2018">2018</option>
                                    <option value="2019">2019</option>
                                    <option value="2020">2020</option>
                                    <option value="2021">2021</option>
                                    <option value="2022">2022</option>
                                    <option value="2023">2023</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">性别</label>
                                <div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="gender" id="gender-male" value="male" checked>
                                        <label class="form-check-label" for="gender-male">男</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="gender" id="gender-female" value="female">
                                        <label class="form-check-label" for="gender-female">女</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 自定义时间输入 -->
                        <div id="custom-time-input" class="mt-3 d-none">
                            <input type="datetime-local" id="custom-date" class="form-control">
                        </div>

                        <!-- 随机数输入 -->
                        <div id="random-number-input" class="mt-3 d-none">
                            <div class="input-group">
                                <input type="number" id="random-number-value" class="form-control" min="1" max="12" value="1">
                                <button class="btn btn-outline-secondary" type="button" onclick="generateRandomNumber()">随机</button>
                            </div>
                            <small class="form-text text-muted">数字1对应子时(23:00-1:00)</small>
                        </div>

                        
                        
                        <!-- 排盘按钮 -->
                        <div class="mt-3 text-center">
                            <button id="generate-chart-btn" class="btn btn-primary">排盘</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 四柱显示 -->
        <div class="sizhu-panel chart-section" style="display: none;">
            <table class="sizhu-table">
                <thead>
                    <tr>
                        <th>年柱</th>
                        <th>月柱</th>
                        <th>日柱</th>
                        <th>时柱</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <span class="gan" id="year-gan">甲</span>
                            <span class="zhi" id="year-zhi">子</span>
                        </td>
                        <td>
                            <span class="gan" id="month-gan">乙</span>
                            <span class="zhi" id="month-zhi">丑</span>
                        </td>
                        <td>
                            <span class="gan" id="day-gan">丙</span>
                            <span class="zhi" id="day-zhi">寅</span>
                        </td>
                        <td>
                            <span class="gan" id="hour-gan">丁</span>
                            <span class="zhi" id="hour-zhi">卯</span>
                        </td>
                    </tr>
                </tbody>
            </table>
            
            <!-- 本命和行年显示 -->
            <div class="row mt-3">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-primary text-white">本命</div>
                        <div class="card-body">
                            <div class="d-flex flex-column justify-content-center align-items-center">
                                <div class="d-flex justify-content-center align-items-center">
                                    <span class="gan me-1" id="benming-gan">-</span>
                                    <span class="zhi" id="benming-zhi">-</span>
                                    <span>&nbsp&nbsp&nbsp </span>
                                    <span class="nayin" id="benming-nayin">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-success text-white">行年</div>
                        <div class="card-body">
                            <div class="d-flex justify-content-center align-items-center">
                                <span class="gan me-1" id="xingnian-gan">-</span>
                                <span class="zhi" id="xingnian-zhi">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 旬干显示 -->
            <!-- <div class="xungan-info">
                <span class="xungan-label">旬首：</span>
                <span class="xungan-value" id="xungan-value">甲子</span>
            </div> -->
            
            <!-- 当前时间显示 -->
            <!-- <div class="time-info">
                <span class="time-label">当前时间：</span>
                <span class="time-value" id="current-time">--:--:--</span>
            </div> -->
        </div>

        
        <!-- 三传表格 -->
        <div class="sanchuan-container chart-section" style="display: none;">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body p-0">
                            <table class="table table-bordered mb-0 text-center"
                                <tbody>
                                    <tr>
                                        <td class="fw-bold">初传</td>
                                        <td id="chuchuan-liuqin">妻财</td>
                                        <td id="chuchuan-shishen">食神</td>
                                        <td id="chuchuan-huayao" style="color: #2196F3;">天暗</td>
                                        <td id="chuchuan-gan" class="text-danger">丙</td>
                                        <td id="chuchuan-zhi">戌</td>
                                        <td id="chuchuan-tianjiang" class="text-success">六合/六合</td>
                                    </tr>
                                    <tr>
                                        <td class="fw-bold">中传</td>
                                        <td id="zhongchuan-liuqin">子孙</td>
                                        <td id="zhongchuan-shishen">比肩</td>
                                        <td id="zhongchuan-huayao" style="color: #4CAF50;">天禄</td>
                                        <td id="zhongchuan-gan" class="text-secondary">甲</td>
                                        <td id="zhongchuan-zhi" class="text-danger">午</td>
                                        <td id="zhongchuan-tianjiang" class="text-primary">天后/白虎</td>
                                    </tr>
                                    <tr>
                                        <td class="fw-bold">末传</td>
                                        <td id="mochuan-liuqin">兄弟</td>
                                        <td id="mochuan-shishen">七杀</td>
                                        <td id="mochuan-huayao" style="color: #F44336;">天刑</td>
                                        <td id="mochuan-gan" class="text-warning">庚</td>
                                        <td id="mochuan-zhi" class="text-success">寅</td>
                                        <td id="mochuan-tianjiang" class="text-warning">白虎/天后</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 四课表格 -->
        <div class="sike-container chart-section" style="display: none;">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body p-0">
                            <table class="table table-bordered mb-0 text-center">
                                <thead class="table-light">
                                    <tr>
                                        <th width="25%">第四课</th>
                                        <th width="25%">第三课</th>
                                        <th width="25%">第二课</th>
                                        <th width="25%">第一课</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><span id="sike-4-tianjiang">支阴天将</span></td>
                                        <td><span id="sike-3-tianjiang">支上天将</span></td>
                                        <td><span id="sike-2-tianjiang">干阴天将</span></td>
                                        <td><span id="sike-1-tianjiang">干上天将</span></td>
                                    </tr>
                                    <tr>
                                        <td><span id="sike-4-top">支阴</span></td>
                                        <td><span id="sike-3-top">支上</span></td>
                                        <td><span id="sike-2-top">干阴</span></td>
                                        <td><span id="sike-1-top">干上</span></td>
                                    </tr>
                                    <tr>
                                        <td><span id="sike-4-bottom">支上</span></td>
                                        <td><span id="sike-3-bottom">日支</span></td>
                                        <td><span id="sike-2-bottom">干上</span></td>
                                        <td><span id="sike-1-bottom">日干</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="plate-container chart-section" style="display: none;">
            <div class="plate-wrapper">
                <table class="plate-table">
                    <tr>
                        <td class="branch-cell" data-branch="巳">
                            <div class="tianpan-tianjiang tianjiang"></div>
                            <div class="tianpan-branch heaven-branch">巳</div>
                            <div class="shishen-liuqin-container">
                                <div class="shishen-display"></div>
                                <div class="liuqin-display"></div>
                                <div class="huayao-display"></div>
                            </div>
                            <div class="sandun-container">
                                <div class="rendun-row">
                                    <div class="rendun-display"></div>
                                    <div class="rendun-nayin"></div>
                                </div>
                                <div class="tiandun-row">
                                    <div class="tiandun-display"></div>
                                    <div class="tiandun-nayin"></div>
                                </div>
                                <div class="xungan-row">
                                    <div class="xungan-display xungan"></div>
                                    <div class="xungan-nayin"></div>
                                </div>
                            </div>
                            <div class="dipan-branch ground-branch">巳</div>
                            <div class="dipan-tianjiang-bottom dipan-tianjiang"></div>
                            <div class="jianjian-display">
                                <div class="jiangan-row">
                                    <span class="jiangan">甲</span>
                                    <div class="jiangan-nayin"></div>
                                </div>
                                <div class="fujian-row">
                                    <span class="fujian">丙</span>
                                    <div class="fujian-nayin"></div>
                                </div>
                            </div>
                            <div class="changsheng-yueling-container">
                                <div class="yueling-display"></div>
                                <div class="changsheng-display"></div>
                            </div>
                            <div class="jianchu-wangshui-container">
                                <div class="jianchu-display"></div>
                                <div class="wangshui-display"></div>
                                <div class="changsheng-display"></div>
                            </div>
                        </td>
                        <td class="branch-cell" data-branch="午">
                            <div class="tianpan-tianjiang tianjiang"></div>
                            <div class="tianpan-branch heaven-branch">午</div>
                            <div class="shishen-liuqin-container">
                                <div class="shishen-display"></div>
                                <div class="liuqin-display"></div>
                                <div class="huayao-display"></div>
                            </div>
                            <div class="sandun-container">
                                <div class="rendun-row">
                                    <div class="rendun-display"></div>
                                    <div class="rendun-nayin"></div>
                                </div>
                                <div class="tiandun-row">
                                    <div class="tiandun-display"></div>
                                    <div class="tiandun-nayin"></div>
                                </div>
                                <div class="xungan-row">
                                    <div class="xungan-display xungan"></div>
                                    <div class="xungan-nayin"></div>
                                </div>
                            </div>
                            <div class="dipan-branch ground-branch">午</div>
                            <div class="dipan-tianjiang-bottom dipan-tianjiang"></div>
                            <div class="jianjian-display">
                                <div class="jiangan-row">
                                    <span class="jiangan">甲</span>
                                    <div class="jiangan-nayin"></div>
                                </div>
                                <div class="fujian-row">
                                    <span class="fujian">丙</span>
                                    <div class="fujian-nayin"></div>
                                </div>
                            </div>
                            <div class="changsheng-yueling-container">
                                <div class="yueling-display"></div>
                                <div class="changsheng-display"></div>
                            </div>
                        </td>
                        <td class="branch-cell" data-branch="未">
                            <div class="tianpan-tianjiang tianjiang"></div>
                            <div class="tianpan-branch heaven-branch">未</div>
                            <div class="shishen-liuqin-container">
                                <div class="shishen-display"></div>
                                <div class="liuqin-display"></div>
                                <div class="huayao-display"></div>
                            </div>
                            <div class="sandun-container">
                                <div class="rendun-row">
                                    <div class="rendun-display"></div>
                                    <div class="rendun-nayin"></div>
                                </div>
                                <div class="tiandun-row">
                                    <div class="tiandun-display"></div>
                                    <div class="tiandun-nayin"></div>
                                </div>
                                <div class="xungan-row">
                                    <div class="xungan-display xungan"></div>
                                    <div class="xungan-nayin"></div>
                                </div>
                            </div>
                            <div class="dipan-branch ground-branch">未</div>
                            <div class="dipan-tianjiang-bottom dipan-tianjiang"></div>
                            <div class="jianjian-display">
                                <div class="jiangan-row">
                                    <span class="jiangan">甲</span>
                                    <div class="jiangan-nayin"></div>
                                </div>
                                <div class="fujian-row">
                                    <span class="fujian">丙</span>
                                    <div class="fujian-nayin"></div>
                                </div>
                            </div>
                            <div class="changsheng-yueling-container">
                                <div class="yueling-display"></div>
                                <div class="changsheng-display"></div>
                            </div>
                        </td>
                        <td class="branch-cell" data-branch="申">
                            <div class="tianpan-tianjiang tianjiang"></div>
                            <div class="tianpan-branch heaven-branch">申</div>
                            <div class="shishen-liuqin-container">
                                <div class="shishen-display"></div>
                                <div class="liuqin-display"></div>
                                <div class="huayao-display"></div>
                            </div>
                            <div class="sandun-container">
                                <div class="rendun-row">
                                    <div class="rendun-display"></div>
                                    <div class="rendun-nayin"></div>
                                </div>
                                <div class="tiandun-row">
                                    <div class="tiandun-display"></div>
                                    <div class="tiandun-nayin"></div>
                                </div>
                                <div class="xungan-row">
                                    <div class="xungan-display xungan"></div>
                                    <div class="xungan-nayin"></div>
                                </div>
                            </div>
                            <div class="dipan-branch ground-branch">申</div>
                            <div class="dipan-tianjiang-bottom dipan-tianjiang"></div>
                            <div class="jianjian-display">
                                <div class="jiangan-row">
                                    <span class="jiangan">甲</span>
                                    <div class="jiangan-nayin"></div>
                                </div>
                                <div class="fujian-row">
                                    <span class="fujian">丙</span>
                                    <div class="fujian-nayin"></div>
                                </div>
                            </div>
                            <div class="changsheng-yueling-container">
                                <div class="yueling-display"></div>
                                <div class="changsheng-display"></div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="branch-cell" data-branch="辰">
                            <div class="tianpan-tianjiang tianjiang"></div>
                            <div class="tianpan-branch heaven-branch">辰</div>
                            <div class="shishen-liuqin-container">
                                <div class="shishen-display"></div>
                                <div class="liuqin-display"></div>
                                <div class="huayao-display"></div>
                            </div>
                            <div class="sandun-container">
                                <div class="rendun-row">
                                    <div class="rendun-display"></div>
                                    <div class="rendun-nayin"></div>
                                </div>
                                <div class="tiandun-row">
                                    <div class="tiandun-display"></div>
                                    <div class="tiandun-nayin"></div>
                                </div>
                                <div class="xungan-row">
                                    <div class="xungan-display xungan"></div>
                                    <div class="xungan-nayin"></div>
                                </div>
                            </div>
                            <div class="dipan-branch ground-branch">辰</div>
                            <div class="dipan-tianjiang-bottom dipan-tianjiang"></div>
                            <div class="jianjian-display">
                                <div class="jiangan-row">
                                    <span class="jiangan">甲</span>
                                    <div class="jiangan-nayin"></div>
                                </div>
                                <div class="fujian-row">
                                    <span class="fujian">丙</span>
                                    <div class="fujian-nayin"></div>
                                </div>
                            </div>
                            <div class="changsheng-yueling-container">
                                <div class="yueling-display"></div>
                                <div class="changsheng-display"></div>
                            </div>
                        </td>
                        <td class="empty-cell"></td>
                        <td class="empty-cell"></td>
                        <td class="branch-cell" data-branch="酉">
                            <div class="tianpan-tianjiang tianjiang"></div>
                            <div class="tianpan-branch heaven-branch">酉</div>
                            <div class="shishen-liuqin-container">
                                <div class="shishen-display"></div>
                                <div class="liuqin-display"></div>
                                <div class="huayao-display"></div>
                            </div>
                            <div class="sandun-container">
                                <div class="rendun-row">
                                    <div class="rendun-display"></div>
                                    <div class="rendun-nayin"></div>
                                </div>
                                <div class="tiandun-row">
                                    <div class="tiandun-display"></div>
                                    <div class="tiandun-nayin"></div>
                                </div>
                                <div class="xungan-row">
                                    <div class="xungan-display xungan"></div>
                                    <div class="xungan-nayin"></div>
                                </div>
                            </div>
                            <div class="dipan-branch ground-branch">酉</div>
                            <div class="dipan-tianjiang-bottom dipan-tianjiang"></div>
                            <div class="jianjian-display">
                                <div class="jiangan-row">
                                    <span class="jiangan">甲</span>
                                    <div class="jiangan-nayin"></div>
                                </div>
                                <div class="fujian-row">
                                    <span class="fujian">丙</span>
                                    <div class="fujian-nayin"></div>
                                </div>
                            </div>
                            <div class="changsheng-yueling-container">
                                <div class="yueling-display"></div>
                                <div class="changsheng-display"></div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="branch-cell" data-branch="卯">
                            <div class="tianpan-tianjiang tianjiang"></div>
                            <div class="tianpan-branch heaven-branch">卯</div>
                            <div class="shishen-liuqin-container">
                                <div class="shishen-display"></div>
                                <div class="liuqin-display"></div>
                                <div class="huayao-display"></div>
                            </div>
                            <div class="sandun-container">
                                <div class="rendun-row">
                                    <div class="rendun-display"></div>
                                    <div class="rendun-nayin"></div>
                                </div>
                                <div class="tiandun-row">
                                    <div class="tiandun-display"></div>
                                    <div class="tiandun-nayin"></div>
                                </div>
                                <div class="xungan-row">
                                    <div class="xungan-display xungan"></div>
                                    <div class="xungan-nayin"></div>
                                </div>
                            </div>
                            <div class="dipan-branch ground-branch">卯</div>
                            <div class="dipan-tianjiang-bottom dipan-tianjiang"></div>
                            <div class="jianjian-display">
                                <div class="jiangan-row">
                                    <span class="jiangan">甲</span>
                                    <div class="jiangan-nayin"></div>
                                </div>
                                <div class="fujian-row">
                                    <span class="fujian">丙</span>
                                    <div class="fujian-nayin"></div>
                                </div>
                            </div>
                            <div class="changsheng-yueling-container">
                                <div class="yueling-display"></div>
                                <div class="changsheng-display"></div>
                            </div>
                        </td>
                        <td class="empty-cell"></td>
                        <td class="empty-cell"></td>
                        <td class="branch-cell" data-branch="戌">
                            <div class="tianpan-tianjiang tianjiang"></div>
                            <div class="tianpan-branch heaven-branch">戌</div>
                            <div class="shishen-liuqin-container">
                                <div class="shishen-display"></div>
                                <div class="liuqin-display"></div>
                                <div class="huayao-display"></div>
                            </div>
                            <div class="sandun-container">
                                <div class="rendun-row">
                                    <div class="rendun-display"></div>
                                    <div class="rendun-nayin"></div>
                                </div>
                                <div class="tiandun-row">
                                    <div class="tiandun-display"></div>
                                    <div class="tiandun-nayin"></div>
                                </div>
                                <div class="xungan-row">
                                    <div class="xungan-display xungan"></div>
                                    <div class="xungan-nayin"></div>
                                </div>
                            </div>
                            <div class="dipan-branch ground-branch">戌</div>
                            <div class="dipan-tianjiang-bottom dipan-tianjiang"></div>
                            <div class="jianjian-display">
                                <div class="jiangan-row">
                                    <span class="jiangan">甲</span>
                                    <div class="jiangan-nayin"></div>
                                </div>
                                <div class="fujian-row">
                                    <span class="fujian">丙</span>
                                    <div class="fujian-nayin"></div>
                                </div>
                            </div>
                            <div class="changsheng-yueling-container">
                                <div class="yueling-display"></div>
                                <div class="changsheng-display"></div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="branch-cell" data-branch="寅">
                            <div class="tianpan-tianjiang tianjiang">太常</div>
                            <div class="tianpan-branch heaven-branch">寅</div>
                            <div class="shishen-liuqin-container">
                                <div class="shishen-display"></div>
                                <div class="liuqin-display"></div>
                                <div class="huayao-display"></div>
                            </div>
                            <div class="sandun-container">
                                <div class="rendun-row">
                                    <div class="rendun-display"></div>
                                    <div class="rendun-nayin"></div>
                                </div>
                                <div class="tiandun-row">
                                    <div class="tiandun-display"></div>
                                    <div class="tiandun-nayin"></div>
                                </div>
                                <div class="xungan-row">
                                    <div class="xungan-display xungan">壬</div>
                                    <div class="xungan-nayin"></div>
                                </div>
                            </div>
                            <div class="dipan-branch ground-branch">寅</div>
                            <div class="dipan-tianjiang-bottom dipan-tianjiang"></div>
                            <div class="jianjian-display">
                                <div class="jiangan-row">
                                    <span class="jiangan">甲</span>
                                    <div class="jiangan-nayin"></div>
                                </div>
                                <div class="fujian-row">
                                    <span class="fujian">丙</span>
                                    <div class="fujian-nayin"></div>
                                </div>
                            </div>
                            <div class="changsheng-yueling-container">
                                <div class="yueling-display"></div>
                                <div class="changsheng-display"></div>
                            </div>
                        </td>
                        <td class="branch-cell" data-branch="丑">
                            <div class="tianpan-tianjiang tianjiang">玄武</div>
                            <div class="tianpan-branch heaven-branch">丑</div>
                            <div class="shishen-liuqin-container">
                                <div class="shishen-display"></div>
                                <div class="liuqin-display"></div>
                                <div class="huayao-display"></div>
                            </div>
                            <div class="sandun-container">
                                <div class="rendun-row">
                                    <div class="rendun-display"></div>
                                    <div class="rendun-nayin"></div>
                                </div>
                                <div class="tiandun-row">
                                    <div class="tiandun-display"></div>
                                    <div class="tiandun-nayin"></div>
                                </div>
                                <div class="xungan-row">
                                    <div class="xungan-display xungan">癸</div>
                                    <div class="xungan-nayin"></div>
                                </div>
                            </div>
                            <div class="dipan-branch ground-branch">丑</div>
                            <div class="dipan-tianjiang-bottom dipan-tianjiang"></div>
                            <div class="jianjian-display">
                                <div class="jiangan-row">
                                    <span class="jiangan">甲</span>
                                    <div class="jiangan-nayin"></div>
                                </div>
                                <div class="fujian-row">
                                    <span class="fujian">丙</span>
                                    <div class="fujian-nayin"></div>
                                </div>
                            </div>
                            <div class="changsheng-yueling-container">
                                <div class="yueling-display"></div>
                                <div class="changsheng-display"></div>
                            </div>
                        </td>
                        <td class="branch-cell" data-branch="子">
                            <div class="tianpan-tianjiang tianjiang">太阴</div>
                            <div class="tianpan-branch heaven-branch">子</div>
                            <div class="shishen-liuqin-container">
                                <div class="shishen-display"></div>
                                <div class="liuqin-display"></div>
                                <div class="huayao-display"></div>
                            </div>
                            <div class="sandun-container">
                                <div class="rendun-row">
                                    <div class="rendun-display"></div>
                                    <div class="rendun-nayin"></div>
                                </div>
                                <div class="tiandun-row">
                                    <div class="tiandun-display"></div>
                                    <div class="tiandun-nayin"></div>
                                </div>
                                <div class="xungan-row">
                                    <div class="xungan-display xungan">甲</div>
                                    <div class="xungan-nayin"></div>
                                </div>
                            </div>
                            <div class="dipan-branch ground-branch">子</div>
                            <div class="dipan-tianjiang-bottom dipan-tianjiang"></div>
                            <div class="jianjian-display">
                                <div class="jiangan-row">
                                    <span class="jiangan">甲</span>
                                    <div class="jiangan-nayin"></div>
                                </div>
                                <div class="fujian-row">
                                    <span class="fujian">丙</span>
                                    <div class="fujian-nayin"></div>
                                </div>
                            </div>
                            <div class="changsheng-yueling-container">
                                <div class="yueling-display"></div>
                                <div class="changsheng-display"></div>
                            </div>
                        </td>
                        <td class="branch-cell" data-branch="亥">
                            <div class="tianpan-tianjiang tianjiang">天后</div>
                            <div class="tianpan-branch heaven-branch">亥</div>
                            <div class="shishen-liuqin-container">
                                <div class="shishen-display"></div>
                                <div class="liuqin-display"></div>
                                <div class="huayao-display"></div>
                            </div>
                            <div class="sandun-container">
                                <div class="rendun-row">
                                    <div class="rendun-display"></div>
                                    <div class="rendun-nayin"></div>
                                </div>
                                <div class="tiandun-row">
                                    <div class="tiandun-display"></div>
                                    <div class="tiandun-nayin"></div>
                                </div>
                                <div class="xungan-row">
                                    <div class="xungan-display xungan">乙</div>
                                    <div class="xungan-nayin"></div>
                                </div>
                            </div>
                            <div class="dipan-branch ground-branch">亥</div>
                            <div class="dipan-tianjiang-bottom dipan-tianjiang"></div>
                            <div class="jianjian-display">
                                <div class="jiangan-row">
                                    <span class="jiangan">甲</span>
                                    <div class="jiangan-nayin"></div>
                                </div>
                                <div class="fujian-row">
                                    <span class="fujian">丙</span>
                                    <div class="fujian-nayin"></div>
                                </div>
                            </div>
                            <div class="changsheng-yueling-container">
                                <div class="yueling-display"></div>
                                <div class="changsheng-display"></div>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        
        <div class="result-info chart-section" style="display: none;">
            <p id="calculation-info">请计算天地盘</p>
        </div>
        
        <!-- 钤法弹出框 -->
        <div id="qianfa-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <span class="close">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="qianfa-content" id="qianfa-content">
                        <!-- 钤法内容将在这里显示 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 原纳音弹出框已集成到钤法弹窗中 -->
    </div>

    <!-- 尝试多个CDN源，确保库能够加载 -->
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.6.12/lunar.min.js" onerror="this.onerror=null;this.src='https://unpkg.com/lunar-javascript@1.6.12/lunar.min.js'"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="script.js?v=2.4"></script>
    <script src="nayin.js?v=1.0"></script>
    <script src="zeidun.js?v=1.3"></script>
    <script src="zeidun-fix.js?v=1.3"></script>
    <script src="custom-sizhu.js?v=1.0"></script>
    <script src="fanyin-fix.js?v=1.0"></script>
            <script>
        // 当文档加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 添加jianchu-wangshui-container到所有单元格
            function addJianchuContainers() {
                const cells = document.querySelectorAll('.branch-cell');
                cells.forEach(cell => {
                    // 检查单元格是否已有jianchu-wangshui-container
                    if (!cell.querySelector('.jianchu-wangshui-container')) {
                        const container = document.createElement('div');
                        container.className = 'jianchu-wangshui-container';
                        
                        // 创建一个行容器，用于放置十二建除和旺衰
                        const jianchuWangshuiRow = document.createElement('div');
                        jianchuWangshuiRow.className = 'jianchu-wangshui-row';
                        
                        // 添加十二建除显示
                        const jianchuDisplay = document.createElement('div');
                        jianchuDisplay.className = 'jianchu-display';
                        jianchuDisplay.style.display = 'inline-block';
                        jianchuDisplay.style.marginRight = '2px';
                        jianchuWangshuiRow.appendChild(jianchuDisplay);
                        
                        // 添加分隔符
                        const separator = document.createElement('span');
                        separator.textContent = '/';
                        separator.style.display = 'inline-block';
                        separator.style.margin = '0 2%';
                        separator.style.fontWeight = 'bold';
                        separator.style.fontSize = '0.7em';
                        jianchuWangshuiRow.appendChild(separator);
                        
                        // 添加旺衰显示
                        const wangshuiDisplay = document.createElement('div');
                        wangshuiDisplay.className = 'wangshui-display';
                        wangshuiDisplay.style.display = 'inline-block';
                        jianchuWangshuiRow.appendChild(wangshuiDisplay);
                        
                        // 将行容器添加到主容器
                        container.appendChild(jianchuWangshuiRow);
                        
                        // 添加长生显示（包含五行长生和十干长生）
                        const changshengDisplay = document.createElement('div');
                        changshengDisplay.className = 'changsheng-display';
                        changshengDisplay.title = '五行长生/十干长生';
                        container.appendChild(changshengDisplay);
                        
                        cell.appendChild(container);
                    }
                });
                
                console.log('已添加十二建除和长生容器到所有单元格');
            }
            
            // 初始添加容器
            setTimeout(addJianchuContainers, 1000);
            
            // 监听排盘按钮点击
            const calculateBtn = document.getElementById('calculate-btn');
            if (calculateBtn) {
                calculateBtn.addEventListener('click', function() {
                    setTimeout(addJianchuContainers, 1000);
                });
            }
            
            // 监听生成图表按钮点击
            const generateChartBtn = document.getElementById('generate-chart-btn');
            if (generateChartBtn) {
                generateChartBtn.addEventListener('click', function() {
                    setTimeout(addJianchuContainers, 1000);
                });
            }
        });
    </script>

<script>
// 在页面加载完成后执行
document.addEventListener('DOMContentLoaded', function() {
    // 天将五行颜色映射 - 天地盘用
    const tianjiangWuxing = {
        '螣蛇': 'fire', '朱雀': 'fire',  // 火
        '勾陈': 'earth', '太常': 'earth', '天空': 'earth', '贵人': 'earth',  // 土
        '六合': 'wood', '青龙': 'wood',  // 木
        '天后': 'water', '玄武': 'water',  // 水
        '白虎': 'metal', '太阴': 'metal'   // 金
    };

    // 天将颜色映射 - 天盘天将颜色
    const tianpanColors = {
        '螣蛇': '#ce2d20', '朱雀': '#ce2d20',  // 火
        '勾陈': '#98511e', '太常': '#98511e', '天空': '#98511e', '贵人': '#98511e',  // 土
        '六合': '#317023', '青龙': '#317023',  // 木
        '天后': '#0803a8', '玄武': '#0803a8',  // 水
        '白虎': '#e08433', '太阴': '#e08433'   // 金
    };

    // 天将颜色映射 - 地盘天将颜色（使用更亮的色调）
    const dipanColors = {
        '螣蛇': '#ce2d20', '朱雀': '#ce2d20',  // 火 - 更亮
        '勾陈': '#98511e', '太常': '#98511e', '天空': '#98511e', '贵人': '#98511e',  // 土 - 更亮
        '六合': '#317023', '青龙': '#317023',  // 木 - 更亮
        '天后': '#0803a8', '玄武': '#0803a8',  // 水 - 更亮
        '白虎': '#e08433', '太阴': '#e08433'   // 金 - 更亮
    };

    // 获取天将的颜色 - 天盘
    function getTianpanColor(tianjiang) {
        for (const [name, color] of Object.entries(tianpanColors)) {
            if (tianjiang.includes(name)) {
                return color;
            }
        }
        return '';
    }

    // 获取天将的颜色 - 地盘
    function getDipanColor(tianjiang) {
        for (const [name, color] of Object.entries(dipanColors)) {
            if (tianjiang.includes(name)) {
                return color;
            }
        }
        return '';
    }

    // 获取天将的五行类
    function getTianjiangClass(tianjiang) {
        for (const [name, wuxing] of Object.entries(tianjiangWuxing)) {
            if (tianjiang.includes(name)) {
                return 'tianjiang-' + wuxing;
            }
        }
        return '';
    }

    // 处理天将显示
    function processTianjiangDisplay() {
        // 处理三传天将
        const sanchuanTianjiang = document.querySelectorAll('#chuchuan-tianjiang, #zhongchuan-tianjiang, #mochuan-tianjiang');
        sanchuanTianjiang.forEach(function(element) {
            if (element && element.textContent) {
                const parts = element.textContent.split('/');
                if (parts.length === 2) {
                    const tianpanColor = getTianpanColor(parts[0]);
                    const dipanColor = getDipanColor(parts[1]);
                    element.innerHTML = '<span class="tianjiang-combo">' +
                        '<span class="tianpan-part" style="color:' + tianpanColor + ';font-weight:bold;">' + parts[0] + '</span>' +
                        '<span class="dipan-part" style="color:' + dipanColor + ';font-weight:bold;">' + parts[1] + '</span>' +
                        '</span>';
                }
            }
        });

        // 处理四课天将
        const sikeTianjiang = document.querySelectorAll('#sike-1-tianjiang, #sike-2-tianjiang, #sike-3-tianjiang, #sike-4-tianjiang');
        sikeTianjiang.forEach(function(element) {
            if (element && element.textContent) {
                const text = element.textContent;
                if (text && text.includes('/')) {
                    const parts = text.split('/');
                    if (parts.length === 2) {
                        const tianpanColor = getTianpanColor(parts[0]);
                        const dipanColor = getDipanColor(parts[1]);
                        element.innerHTML = '<span class="tianjiang-combo">' +
                            '<span class="tianpan-part" style="color:' + tianpanColor + ';font-weight:bold;">' + parts[0] + '</span>' +
                            '<span class="dipan-part" style="color:' + dipanColor + ';font-weight:bold;">' + parts[1] + '</span>' +
                            '</span>';
                    }
                }
            }
        });

        // 处理天盘天将
        const tianpanTianjiang = document.querySelectorAll('.tianpan-tianjiang');
        tianpanTianjiang.forEach(function(element) {
            if (element && element.textContent) {
                const tianjiangName = element.textContent.trim();
                const tianjiangClass = getTianjiangClass(tianjiangName);
                if (tianjiangClass) {
                    element.classList.add(tianjiangClass);
                }
            }
        });

        // 处理地盘天将
        const dipanTianjiang = document.querySelectorAll('.dipan-tianjiang-bottom');
        dipanTianjiang.forEach(function(element) {
            if (element && element.textContent) {
                const tianjiangName = element.textContent.trim();
                const tianjiangClass = getTianjiangClass(tianjiangName);
                if (tianjiangClass) {
                    element.classList.add(tianjiangClass);
                }
            }
        });
    }

    // 初始处理
    setTimeout(processTianjiangDisplay, 1000);

    // 监听排盘按钮点击
    const calculateBtn = document.getElementById('calculate-btn');
    if (calculateBtn) {
        calculateBtn.addEventListener('click', function() {
            setTimeout(processTianjiangDisplay, 1000);
        });
    }

    // 监听生成图表按钮点击
    const generateChartBtn = document.getElementById('generate-chart-btn');
    if (generateChartBtn) {
        generateChartBtn.addEventListener('click', function() {
            setTimeout(processTianjiangDisplay, 1000);
        });
    }
});
</script>
</body>
</html>
